tosca_definitions_version: huaweicloud_tosca_version_1_0
metadata:
  Designer:
    9f1982bd-d781-4654-8651-72b622b9b5d9:
      size:
        width: 60
        height: 60
      position:
        x: 348
        'y': 190
      z: 1
      dependson:
        - 08c3c168-5b00-4a70-b9f2-b74f3e276d9d
    e66e332a-3466-4638-9896-f7d2e93a1ae3:
      size:
        width: 60
        height: 60
      position:
        x: 450
        'y': 290
      z: 1
      dependson:
        - ce9364da-97d9-4437-8555-1387d0675813
        - a6ab4132-85ad-4aef-b022-64a2f2c5094c
        - 08c3c168-5b00-4a70-b9f2-b74f3e276d9d
    a6ab4132-85ad-4aef-b022-64a2f2c5094c:
      size:
        width: 60
        height: 60
      position:
        x: 450
        'y': 190
      z: 1
      dependson:
        - 9f1982bd-d781-4654-8651-72b622b9b5d9
    9195b732-bcf2-40cb-8617-e734f09f8080:
      source:
        id: 9f1982bd-d781-4654-8651-72b622b9b5d9
      target:
        id: 35827477-c989-4bfb-85d2-2e62691a2e0e
      z: 1
    f179109e-ba6f-4c24-b8e6-dc09e47fb59c:
      source:
        id: a6ab4132-85ad-4aef-b022-64a2f2c5094c
      target:
        id: 9f1982bd-d781-4654-8651-72b622b9b5d9
      z: 1
    ce9364da-97d9-4437-8555-1387d0675813:
      size:
        width: 60
        height: 60
      position:
        x: 240
        'y': 290
      z: 1
    4d06e8a8-74c6-47f7-8a96-0301a4707e73:
      source:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
      target:
        id: ce9364da-97d9-4437-8555-1387d0675813
      z: 1
    2ff7ec0c-8769-492a-8599-f8ac13e115da:
      source:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
      target:
        id: a6ab4132-85ad-4aef-b022-64a2f2c5094c
      z: 1
    a62275e5-8959-42ce-b8bb-b326e7e34f12:
      size:
        width: 60
        height: 60
      position:
        x: 570
        'y': 290
      z: 1
      dependson:
        - e66e332a-3466-4638-9896-f7d2e93a1ae3
    9c16fa66-cd0c-44d5-a9ec-1d634f6a882e:
      source:
        id: a62275e5-8959-42ce-b8bb-b326e7e34f12
      target:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
      z: 1
    83601dee-54ca-4c6e-bf67-0ea6c7820e00:
      source:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
      target:
        id: 35827477-c989-4bfb-85d2-2e62691a2e0e
      z: 1
    08c3c168-5b00-4a70-b9f2-b74f3e276d9d:
      size:
        width: 60
        height: 60
      position:
        x: 240
        'y': 190
      z: 1
    fb63eb79-a205-4756-b4fc-753f38277bde:
      source:
        id: 9f1982bd-d781-4654-8651-72b622b9b5d9
      target:
        id: 08c3c168-5b00-4a70-b9f2-b74f3e276d9d
      z: 1
    a85a76e9-c5f3-4c2c-af48-b836660f5a47:
      source:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
      target:
        id: 08c3c168-5b00-4a70-b9f2-b74f3e276d9d
      z: 1
    ca2217d1-c3aa-4bbf-b14e-f217b1f54aae:
      source:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
        selector: 'g:nth-child(1) > g:nth-child(4) > g:nth-child(1) > circle:nth-child(1)'
        port: >-
          HuaweiCloud.DependencyLink-HuaweiCloud.CCE.Storage.OBS/HuaweiCloud.CCE.NfsVolume/HuaweiCloud.CCE.Service/HuaweiCloud.CCE.DaemonSet/HuaweiCloud.CCE.StatefulSet/HuaweiCloud.CCE.Secret/HuaweiCloud.CCE.NodePool/HuaweiCloud.AOS.Batch/HuaweiCloud.CCE.Deployment/HuaweiCloud.CCE.Job/HuaweiCloud.CCE.ConfigMap/HuaweiCloud.CCE.Storage.SFS
      target:
        id: 08c3c168-5b00-4a70-b9f2-b74f3e276d9d
      z: 3
  relationships:
    9f1982bd-d781-4654-8651-72b622b9b5d9:
      references:
        dependency:
          - get_reference: mysql-conf
    a6ab4132-85ad-4aef-b022-64a2f2c5094c:
      references:
        dependency:
          - get_reference: mysql
    e66e332a-3466-4638-9896-f7d2e93a1ae3:
      references:
        dependency:
          - get_reference: mysql-service
          - get_reference: mysql-conf
          - get_reference: magento-config
    a62275e5-8959-42ce-b8bb-b326e7e34f12:
      references:
        dependency:
          - get_reference: magento

mappings:
  region_map:
    cn-north-1:
      magento-image:
        100.125.0.198:20202/aos-samples/magento:1.9.1.0
      mysql-image:
        100.125.0.198:20202/aos-samples/mysql:latest
    cn-east-2:
      magento-image:
        100.125.17.64:20202/aos-samples/magento:1.9.1.0
      mysql-image:
        100.125.17.64:20202/aos-samples/mysql:latest
    cn-south-1:
      magento-image:
        100.125.16.65:20202/aos-samples/magento:1.9.1.0
      mysql-image:
        100.125.16.65:20202/aos-samples/mysql:latest

node_templates:
  mysql:
    type: HuaweiCloud.CCE.Deployment
    properties:
      k8sManifest:
        kind: Deployment
        apiVersion: apps/v1
        metadata:
          name:
            get_input: mysql-service-name
          labels:
            app:
              get_input: mysql-service-name
        spec:
          replicas: 1
          selector:
            matchLabels:
              app:
                get_input: mysql-service-name
          template:
            metadata:
              labels:
                app:
                  get_input: mysql-service-name
            spec:
              containers:
                - name: mysql-container
                  image:
                    get_in_map:
                      - region_map
                      - get_input: HuaweiCloud.Region
                      - mysql-image
                  ports:
                    - containerPort: 3306
                      protocol: TCP
                  env:
                    - name: MYSQL_DATABASE
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-database
                    - name: MYSQL_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-password
                    - name: MYSQL_ROOT_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-root-password
                    - name: MYSQL_USER
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-user
                  terminationMessagePath: /dev/termination-log
                  terminationMessagePolicy: File
                  imagePullPolicy: IfNotPresent
              imagePullSecrets:
                - name: default-secret
    metadata:
      Designer:
        id: 9f1982bd-d781-4654-8651-72b622b9b5d9
    requirements:
      - dependency:
          node: mysql-conf
  magento:
    type: HuaweiCloud.CCE.Deployment
    properties:
      k8sManifest:
        kind: Deployment
        apiVersion: apps/v1
        metadata:
          name:
            get_input: app-name
          labels:
            app:
              get_input: app-name
        spec:
          replicas: 1
          selector:
            matchLabels:
              app:
                get_input: app-name
          template:
            metadata:
              labels:
                app:
                  get_input: app-name
            spec:
              containers:
                - name: magento-container
                  image:
                    get_in_map:
                      - region_map
                      - get_input: HuaweiCloud.Region
                      - magento-image
                  ports:
                    - containerPort: 80
                      protocol: TCP
                  env:
                    - name: MAGENTO_ADMIN_EMAIL
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-admin-email
                    - name: MAGENTO_ADMIN_FIRSTNAME
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-admin-firstname
                    - name: MAGENTO_ADMIN_LASTNAME
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-admin-lastname
                    - name: MAGENTO_ADMIN_PASSWORD
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-admin-password
                    - name: MAGENTO_ADMIN_USERNAME
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-admin-username
                    - name: MAGENTO_DEFAULT_CURRENCY
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-default-currency
                    - name: MAGENTO_LOCALE
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-locale
                    - name: MAGENTO_TIMEZONE
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-timezone
                    - name: MAGENTO_URL
                      valueFrom:
                        configMapKeyRef:
                          name:
                            get_attribute:
                              - magento-config
                              - refName
                          key: magento-url
                    - name: MYSQL_DATABASE
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-database
                    - name: MYSQL_HOST
                      value:
                        concat:
                          - get_input: mysql-service-name
                          - .default.svc.cluster.local
                    - name: MYSQL_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-password
                    - name: MYSQL_USER
                      valueFrom:
                        secretKeyRef:
                          name:
                            get_input: mysql-service-name
                          key: mysql-user
                  lifecycle:
                    postStart:
                      exec:
                        command:
                          - /bin/sh
                          - '-c'
                          - >-
                            sleep
                            10;/usr/local/bin/install-sampledata;/usr/local/bin/install-magento
              imagePullSecrets:
                - name: default-secret
    metadata:
      Designer:
        id: e66e332a-3466-4638-9896-f7d2e93a1ae3
    requirements:
      - dependency:
          node: mysql-service
      - dependency:
          node: mysql-conf
      - dependency:
          node: magento-config
  magento-config:
    type: HuaweiCloud.CCE.ConfigMap
    properties:
      data:
        magento-admin-email: admin@example.com
        magento-admin-firstname: Admin
        magento-admin-lastname: MyStore
        magento-admin-password: magentorocks1
        magento-admin-username: admin
        magento-default-currency: CNY
        magento-locale: zh_CN
        magento-timezone: Asia/Shanghai
        magento-url:
          concat:
            - 'http://'
            - get_input: magento-EIP
            - ':'
            - get_input: magento-EPORT
        mysql-host:
          concat:
            - get_input: mysql-service-name
            - .default.svc.cluster.local
    metadata:
      Designer:
        id: ce9364da-97d9-4437-8555-1387d0675813
  mysql-service:
    type: HuaweiCloud.CCE.Service
    properties:
      k8sManifest:
        kind: Service
        apiVersion: v1
        metadata:
          name:
            get_input: mysql-service-name
          labels:
            app:
              get_input: mysql-service-name
        spec:
          ports:
            - protocol: TCP
              port: 3306
              targetPort: 3306
          selector:
            app:
              get_input: mysql-service-name
    metadata:
      Designer:
        id: a6ab4132-85ad-4aef-b022-64a2f2c5094c
    requirements:
      - dependency:
          node: mysql
  magento-service:
    type: HuaweiCloud.CCE.Service
    properties:
      k8sManifest:
        kind: Service
        apiVersion: v1
        metadata:
          name:
            get_input: app-name
          labels:
            app:
              get_input: app-name
        spec:
          ports:
            - port: 80
              targetPort: 80
              nodePort:
                get_input: magento-EPORT
              protocol: TCP
          type: NodePort
          selector:
            app:
              get_input: app-name
    metadata:
      Designer:
        id: a62275e5-8959-42ce-b8bb-b326e7e34f12
    requirements:
      - dependency:
          node: magento
  mysql-conf:
    type: HuaweiCloud.CCE.Secret
    properties:
      data:
        mysql-database:
          get_input: mysql-database
        mysql-password:
          get_input: mysql-password
        mysql-root-password:
          get_input: mysql-root-password
        mysql-user:
          get_input: mysql-user
      name:
        get_input: mysql-service-name
      type: Opaque
    metadata:
      Designer:
        id: 08c3c168-5b00-4a70-b9f2-b74f3e276d9d
inputs:
  magento-EIP:
    description: magento服务对外暴露访问地址##External access address of the Magento service
    label: magento
  magento-EPORT:
    default: 32080
    description: magento服务对外监听端口##External listening port of the Magento service
    label: magento
    type: integer
  mysql-database:
    default: magento
    description: mysql数据库服务为magento服务创建的database名称##Name of the database created for the Magento service by the MySQL database service
    label: mysql
  mysql-password:
    default: magento
    description: mysql数据库服务密码##Password of the MySQL database service
    label: mysql
  mysql-port:
    default: 3306
    description: mysql数据库服务监听端口##Listening port for the MySQL database service
    label: mysql
    type: integer
  mysql-root-password:
    default: changeme
    description: mysql数据库服务root用户密码##Password of the root user of the MySQL database service
    label: mysql
  mysql-service-name:
    default: magento-mysql
    description: mysql数据库服务的名称##Name of the MySQL database service
    label: mysql
  mysql-user:
    default: magento
    description: mysql数据库服务用户名##User name of the MySQL database service
    label: mysql
  app-name:
    default: magento
    description: 应用名称##Application name
    label: magento
outputs:
  ingress-admin_password:
    description: Password of super user.
    value: magentorocks1
  magento-addr:
    description: Access URL for magento service.
    value:
      concat:
        - 'http://'
        - get_input: magento-EIP
        - ':'
        - get_input: magento-EPORT
  magento-admin_username:
    description: Super user name.
    value: admin
